name: Build AppImage
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  schedule:
    - cron: '30 09 * * 5'
  pull_request:
    branches: master
    paths:
    - '**'
    - '!**.yml'
    - '!**.md'
    - '**/appimage.yml'

jobs:
  build-appimage:
    runs-on: ubuntu-22.04
    container: andy5995/netpanzer-build-env:focal
    env:
      ARCH: x86_64
      WORKSPACE: ${{ github.workspace }}
    steps:
    - uses: actions/checkout@v4

    - name: Set version
      run: |
        VERSION="$(echo ${GITHUB_SHA} | head -c 7)-$(date +%y%m%d%H%M)"
        echo "VERSION=${VERSION}" >> $GITHUB_ENV

    - name: Prepare AppImage
      run: |
        export -p
        support/scripts/make-appimage.sh

    - name: Release AppImage
      if: ${{ github.ref == 'refs/heads/master' }}
      uses: ncipollo/release-action@v1
      with:
        allowUpdates: true
        artifactErrorsFailBuild: true
        name: NetPanzer Weekly AppImage (Unstable)
        prerelease: true
        draft: true
        artifacts: "${{ env.WORKSPACE }}/support/NetPanz*.AppImage*"
        token: ${{ secrets.GITHUB_TOKEN }}
        omitBody: true
        omitBodyDuringUpdate: true
        omitNameDuringUpdate: true
        tag: appimage-weekly
        removeArtifacts: true

    - if: ${{ github.ref != 'refs/heads/master' }}
      name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: netpanzer_appimage
        path: ${{ github.workspace }}/support/NetPanz*.AppImage*

