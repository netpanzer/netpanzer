ARG CODENAME
FROM ubuntu:$CODENAME
# CODENAME needs to be declared again after importing the image above
ARG CODENAME
ARG DEBIAN_FRONTEND=noninteractive
RUN apt update && apt install -y wget
ARG TARGETARCH
ARG ARCH
ENV TOOLS_DIR=/tools
RUN mkdir -p $TOOLS_DIR
# if ARCH is assigned in one RUN block, the value is lost
# if used in a separate one.
RUN if [ "$TARGETARCH" = "amd64" ]; then \
      ARCH="x86_64"; \
    elif [ "$TARGETARCH" = "arm64" ]; then \
      ARCH="aarch64"; \
    fi && \
    if [ "$ARCH" = "x86_64" ] && [ "$CODENAME" = "focal" ]; then \
        cd $TOOLS_DIR; \
        wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/1-alpha-20231206-1/linuxdeploy-$ARCH.AppImage; \
        chmod +x linuxdeploy-$ARCH.AppImage && \
        ./linuxdeploy-$ARCH.AppImage --appimage-extract; \
        rm ./linuxdeploy-$ARCH.AppImage; \
        cd -; \
    fi

RUN apt upgrade -y && apt install -y \
        build-essential \
        gettext \
        git \
        liblua5.1-dev \
        libphysfs-dev \
        libsdl2-dev \
        libsdl2-mixer-dev \
        libsdl2-ttf-dev && \
        if [ "$CODENAME" = "focal" ]; then \
          apt install -y python3-pip; \
          python3 -m pip install meson ninja; \
        else \
          apt install -y meson ninja-build; \
        fi
        # rm -rf /var/lib/apt/lists && \

RUN apt install -y \
          cmake \
          libjpeg-dev \
          libpng-dev && \
        git clone https://github.com/linuxdeploy/linuxdeploy --recurse-submodules && \
        cd linuxdeploy && \
        cmake -G Ninja . -DCMAKE_C_FLAGS=-I$PWD/src/core/copyright -DSTATIC_BUILD=ON -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_BUILD_TYPE=RelWithDebInfo && \
        ninja install

RUN useradd -m npbuilder && passwd -d npbuilder

ENV DOCKER_NP_BUILD=TRUE

CMD ["/bin/bash","-l"]
