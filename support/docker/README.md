# Docker

Use `docker pull ghcr.io/netpanzer/netpanzer:latest' to get the latest image.
You can view the architectures available at
https://github.com/netpanzer/netpanzer/pkgs/container/netpanzer and clicking
the "OS/Arch" tab.

## Run a dedicated server in a container

Copy docker-compose.yml and the opt directory to anywhere you like, such as
`$HOME/.local/netpanzer`

Edit $HOME/.local/netpanzer/opt/config/server.cfg` as desired. See
[SERVER-HOWTO.md](https://github.com/netpanzer/netpanzer/blob/master/docs/SERVER-HOWTO.md)
if you need help with the options.

To run NetPanzer in a docker container, in the directory containing
docker-compose.yml, use

    docker-compose up -d

To kill the server:

    docker-compose down

If you wish to run a bot in the container after it's started:

    docker exec --user npserver -it netpanzer-server \
        netpanzer -b localhost:3031 --game_config=.netpanzer/config/bot-khan.cfg

Also see the [docker compose
docs](https://docs.docker.com/compose/features-uses/) for more options and
ways to edit the compose yml in this directory.

You may alternatively wish to use from a specific release. You may edit the
compose file to use a different tag.

## Playing from a container

Note the following instructions were adapted from instructions generated by
ChatGPT. The X11 instructions were tested on Manjaro Linux. Use at your own
risk. Please update these docs if you have any information about accuracy or
security-related considerations.

To run an application from a Docker container that requires access to the host
machine's graphics (such as a GUI application), you'll need to share certain
resources from the host with the container. This involves passing through the
host's display (X11 or Wayland, depending on your system) and sharing the
necessary devices. Here's a general guide:

### For X11-based systems (e.g., most Linux desktop environments)

1. **Install dependencies on the host:**
   Make sure you have `xhost` installed, which allows you to control access to
   the X server.

   ```bash
   sudo apt install x11-xserver-utils  # For Ubuntu/Debian
   sudo pacman -S xorg-xhost  # For Arch-based
   ```

2. **Allow access to X server:**
   Before running the container, allow Docker to access your X server:

   ```bash
   xhost +local:docker
   ```

3. **Run the container with access to the display:**
   When starting the container, pass the display environment variable
   (`$DISPLAY`) and mount the X11 socket:

   ```bash
   docker run -it \
       --env="DISPLAY" \
       --env="QT_X11_NO_MITSHM=1" \
       --volume="/tmp/.X11-unix:/tmp/.X11-unix:rw" \
       ghcr.io/netpanzer/netpanzer
   ```

   - `--env="DISPLAY"`: Passes the display from the host to the container.
   - `--env="QT_X11_NO_MITSHM=1"`: Some applications may need this to avoid shared memory issues.
   - `--volume="/tmp/.X11-unix:/tmp/.X11-unix:rw"`: Shares the X11 socket.

4. **Run the graphical application inside the container:**
   Once inside the container, running the app should open its GUI on your host's screen.

### For Wayland-based systems (e.g., some modern Linux environments):

1. **Share the Wayland display:**
   If your system uses Wayland, you need to pass the Wayland display and devices:

   ```bash
   docker run -it \
       --env="WAYLAND_DISPLAY=$WAYLAND_DISPLAY" \
       --volume="/run/user/$(id -u)/wayland:/run/user/$(id -u)/wayland" \
       --device=/dev/dri \
       ghcr.io/netpanzer/netpanzer
   ```

   - `--env="WAYLAND_DISPLAY=$WAYLAND_DISPLAY"`: Passes the Wayland display variable.
   - `--volume="/run/user/$(id -u)/wayland:/run/user/$(id -u)/wayland"`: Shares the Wayland display socket.
   - `--device=/dev/dri`: Provides access to GPU devices (for rendering).

### Additional considerations:

- **GPU access**: If your application requires GPU acceleration (e.g.,
OpenGL), you may also need to pass through GPU devices to the container. For
example, with NVIDIA, you can use the NVIDIA Docker runtime:

   ```bash
   docker run --gpus all -it ghcr.io/netpanzer/netpanzer
   ```

- **X11 access security**: Allowing Docker to connect to your X server with `xhost +local:docker` is not secure. After you're done, revoke access:

   ```bash
   xhost -local:docker
   ```
