env:
  NETPANZER_DATADIR: $CIRRUS_WORKING_DIR/data

# Define a template for tasks
.job_template: &job_template
  only_if: "changesInclude(
    'src/**/**',
    '**meson.build',
    'setup-build.*',
    'subprojects/*.wrap',
    '.cirrus.yml'
    )"
  env:
    CIRRUS_CLONE_SUBMODULES: true
  setup_script:
    - ./setup-build.sh _build
  build_script:
    - cd _build && ninja -v
  test_script:
    - cd _build && meson test --suite=netpanzer -v

freebsd_task:
  <<: *job_template
  name: FreeBSD 13.2
  freebsd_instance:
    image_family: freebsd-13-2
  pkginstall_script:
    - pkg update -f
    - pkg install -y gettext meson ninja physfs pkgconf SDL2 sdl2_mixer sdl2_ttf

arm_task:
  <<: *job_template
  name: Ubuntu arm64
  arm_container:
    image: andy5995/netpanzer-build-env:jammy

macos_task:
  <<: *job_template
  name: macOS arm64
  macos_instance:
    image: ghcr.io/cirruslabs/macos-ventura-xcode:latest
  pkginstall_script:
    - brew update
    - brew install gettext meson ninja physfs sdl2 sdl2_ttf sdl2_mixer
    - brew unlink gettext && brew link gettext --force
    - ./setup-build.sh _build -Dnls=false
